<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat â€” Life OS</title>
<link rel="stylesheet" href="css/main.css?v=2">
<style>
.chat-wrap {
  display: flex;
  flex-direction: column;
  height: calc(100vh - 57px);
  padding-bottom: 80px;
}
.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 12px 16px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.chat-bubble {
  max-width: min(80%, calc(100vw - 48px));
  padding: 10px 14px;
  border-radius: 16px;
  font-size: 14px;
  line-height: 1.45;
  white-space: pre-wrap;
  word-break: break-word;
  overflow-wrap: anywhere;
  box-sizing: border-box;
}
.chat-bubble.luke {
  align-self: flex-end;
  background: var(--blue);
  color: #fff;
  border-bottom-right-radius: 4px;
  margin-left: 40px;
}
.chat-bubble.claude {
  align-self: flex-start;
  background: var(--gray-50);
  color: var(--gray-900);
  border: 1px solid var(--gray-200);
  border-bottom-left-radius: 4px;
  margin-right: 40px;
}
/* Mobile: tighter bubbles, shifted right */
@media (max-width: 600px) {
  .chat-bubble {
    max-width: min(58%, calc(100vw - 56px));
    padding: 7px 10px;
    font-size: 13px;
  }
  /* Luke bubbles: bigger left margin pushes them further right */
  .chat-bubble.luke  { margin-left: 48px; margin-right: 0; }
  /* Claude bubbles: pushed right by left margin, not pinned to left edge */
  .chat-bubble.claude { margin-left: 16px; margin-right: 48px; }
}
.chat-bubble .chat-meta {
  font-size: 11px;
  opacity: 0.6;
  margin-top: 4px;
}
.chat-bubble.luke .chat-meta { text-align: right; }
.chat-bubble .chat-status {
  font-size: 11px;
  opacity: 0.7;
  margin-top: 2px;
}
.chat-input-bar {
  position: fixed;
  bottom: var(--nav-height, 60px);
  left: 0; right: 0;
  background: var(--white);
  border-top: 1px solid var(--gray-200);
  padding: 10px 16px;
  display: flex;
  gap: 8px;
  z-index: 100;
}
.chat-input-bar textarea {
  flex: 1;
  border: 1px solid var(--gray-300);
  border-radius: 20px;
  padding: 8px 14px;
  font-size: 14px;
  resize: none;
  outline: none;
  min-height: 38px;
  max-height: 120px;
  font-family: inherit;
  line-height: 1.4;
}
.chat-input-bar textarea:focus {
  border-color: var(--blue);
}
.chat-send-btn {
  width: 38px; height: 38px;
  border-radius: 50%;
  background: var(--blue);
  color: white;
  border: none;
  font-size: 18px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.chat-send-btn:disabled { background: var(--gray-300); cursor: not-allowed; }
.chat-empty {
  text-align: center;
  color: var(--gray-400);
  padding: 40px 20px;
  font-size: 14px;
}
.chat-date-divider {
  text-align: center;
  font-size: 11px;
  color: var(--gray-400);
  margin: 4px 0;
}
/* â”€â”€ Slash command popup â”€â”€ */
.slash-menu {
  position: fixed;
  bottom: calc(var(--nav-height, 60px) + 60px);
  left: 16px; right: 16px;
  max-width: 400px;
  margin: 0 auto;
  background: var(--white);
  border: 1.5px solid var(--gray-200);
  border-radius: 14px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.15);
  z-index: 200;
  overflow: hidden;
}
.slash-menu-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  cursor: pointer;
  transition: background .1s;
  border-bottom: 1px solid var(--gray-100);
}
.slash-menu-item:last-child { border-bottom: none; }
.slash-menu-item:hover, .slash-menu-item.active { background: var(--gray-50); }
.slash-menu-item .slash-icon {
  width: 34px; height: 34px; border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; flex-shrink: 0;
}
.slash-menu-item .slash-info { flex: 1; }
.slash-menu-item .slash-cmd { font-size: 13px; font-weight: 700; color: var(--gray-900); }
.slash-menu-item .slash-desc { font-size: 11px; color: var(--gray-400); margin-top: 1px; }
.slash-hint {
  font-size: 11px; color: var(--gray-400);
  padding: 4px 16px 8px;
  border-top: 1px solid var(--gray-100);
  text-align: center;
}
/* â”€â”€ Quick-action modals inside chat â”€â”€ */
.chat-modal-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,0.45); z-index: 500;
  align-items: flex-end; justify-content: center;
}
.chat-modal-sheet {
  background: var(--white); border-radius: 16px 16px 0 0;
  padding: 20px; width: 100%; max-width: 600px;
  max-height: 80vh; overflow-y: auto;
}
.chat-modal-title { font-size: 16px; font-weight: 700; margin-bottom: 14px; }
.chat-form-input {
  width: 100%; padding: 10px 14px; border-radius: 10px;
  border: 1.5px solid var(--gray-200); font-size: 15px;
  font-family: inherit; box-sizing: border-box; margin-bottom: 10px;
  background: var(--gray-50, #f9fafb);
}
.chat-form-input:focus { outline: none; border-color: var(--blue); }
.chat-time-row {
  display: flex; gap: 8px; margin-bottom: 12px;
}
.chat-time-row input { flex: 1; }
.chat-pill-row { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; }
.chat-pill {
  padding: 6px 12px; border-radius: 99px; font-size: 12px; font-weight: 600;
  border: 1.5px solid var(--gray-200); background: var(--gray-50,#f9fafb);
  cursor: pointer; transition: all .15s; color: var(--gray-600);
}
.chat-pill.selected { background: var(--blue); border-color: var(--blue); color: #fff; }
</style>
</head>
<body>

<header class="page-header">
  <div class="header-row">
    <div>
      <h1>ğŸ’¬ Chat con Claude</h1>
      <div class="subtitle">EnvÃ­a mensajes, Claude responde cada sesiÃ³n</div>
    </div>
  </div>
</header>

<div class="chat-wrap">
  <div class="chat-messages" id="chat-messages">
    <div class="chat-empty">
      <div style="font-size:32px;margin-bottom:8px">ğŸ’¬</div>
      Cargando mensajesâ€¦
    </div>
  </div>
</div>

<!-- Slash command popup -->
<div class="slash-menu" id="slash-menu" style="display:none">
  <div class="slash-menu-item" data-cmd="remind" onclick="selectSlashCmd('remind')">
    <div class="slash-icon" style="background:#eff6ff">ğŸ””</div>
    <div class="slash-info">
      <div class="slash-cmd">/remind</div>
      <div class="slash-desc">Crear recordatorio con hora y fecha</div>
    </div>
  </div>
  <div class="slash-menu-item" data-cmd="task" onclick="selectSlashCmd('task')">
    <div class="slash-icon" style="background:#f0fdf4">âœ…</div>
    <div class="slash-info">
      <div class="slash-cmd">/task</div>
      <div class="slash-desc">Agregar tarea a la lista</div>
    </div>
  </div>
  <div class="slash-menu-item" data-cmd="note" onclick="selectSlashCmd('note')">
    <div class="slash-icon" style="background:#fffbeb">ğŸ“</div>
    <div class="slash-info">
      <div class="slash-cmd">/note</div>
      <div class="slash-desc">Crear nota rÃ¡pida</div>
    </div>
  </div>
  <div class="slash-hint">â†‘â†“ navegar Â· Enter seleccionar Â· Esc cerrar</div>
</div>

<!-- /remind quick modal -->
<div class="chat-modal-overlay" id="chat-remind-modal" onclick="if(event.target===this)closeChatModal('remind')">
  <div class="chat-modal-sheet">
    <div class="chat-modal-title">ğŸ”” Nuevo recordatorio</div>
    <input type="text" class="chat-form-input" id="cr-title" placeholder="Â¿QuÃ© necesitas recordar?">
    <div class="chat-time-row">
      <input type="time" class="chat-form-input chat-time-row" id="cr-time" style="margin-bottom:0">
      <input type="date" class="chat-form-input chat-time-row" id="cr-date" style="margin-bottom:0">
    </div>
    <div class="chat-pill-row" id="cr-mod-pills">
      <button class="chat-pill selected" data-mod="Personal" onclick="pickChatPill(this,'cr-mod-pills')">ğŸ‘¤ Personal</button>
      <button class="chat-pill" data-mod="RT" onclick="pickChatPill(this,'cr-mod-pills')">ğŸ« RT</button>
      <button class="chat-pill" data-mod="TOV" onclick="pickChatPill(this,'cr-mod-pills')">ğŸ’ TOV</button>
      <button class="chat-pill" data-mod="Health" onclick="pickChatPill(this,'cr-mod-pills')">ğŸƒ Salud</button>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-primary" style="flex:1;padding:12px" onclick="submitChatRemind()">Guardar</button>
      <button class="btn btn-ghost" onclick="closeChatModal('remind')">Cancelar</button>
    </div>
  </div>
</div>

<!-- /task quick modal -->
<div class="chat-modal-overlay" id="chat-task-modal" onclick="if(event.target===this)closeChatModal('task')">
  <div class="chat-modal-sheet">
    <div class="chat-modal-title">âœ… Nueva tarea</div>
    <input type="text" class="chat-form-input" id="ct-title" placeholder="Â¿QuÃ© hay que hacer?">
    <div class="chat-pill-row" id="ct-cat-pills">
      <button class="chat-pill selected" data-cat="Personal" onclick="pickChatPill(this,'ct-cat-pills')">ğŸ‘¤ Personal</button>
      <button class="chat-pill" data-cat="RT" onclick="pickChatPill(this,'ct-cat-pills')">ğŸ« RT</button>
      <button class="chat-pill" data-cat="TOV" onclick="pickChatPill(this,'ct-cat-pills')">ğŸ’ TOV</button>
      <button class="chat-pill" data-cat="Health" onclick="pickChatPill(this,'ct-cat-pills')">ğŸƒ Salud</button>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-primary" style="flex:1;padding:12px" onclick="submitChatTask()">Guardar</button>
      <button class="btn btn-ghost" onclick="closeChatModal('task')">Cancelar</button>
    </div>
  </div>
</div>

<!-- /note quick modal -->
<div class="chat-modal-overlay" id="chat-note-modal" onclick="if(event.target===this)closeChatModal('note')">
  <div class="chat-modal-sheet">
    <div class="chat-modal-title">ğŸ“ Nueva nota</div>
    <input type="text" class="chat-form-input" id="cn-title" placeholder="TÃ­tulo de la nota">
    <textarea class="chat-form-input" id="cn-body" rows="4" placeholder="Contenidoâ€¦" style="resize:vertical"></textarea>
    <div style="display:flex;gap:8px">
      <button class="btn btn-primary" style="flex:1;padding:12px" onclick="submitChatNote()">Guardar</button>
      <button class="btn btn-ghost" onclick="closeChatModal('note')">Cancelar</button>
    </div>
  </div>
</div>

<div class="chat-input-bar">
  <textarea id="chat-input" placeholder="Mensaje o / para acciones rÃ¡pidasâ€¦" rows="1"
    oninput="onChatInput(this)"
    onkeydown="onChatKeydown(event)"></textarea>
  <button class="chat-send-btn" onclick="sendMessage()" id="chat-send-btn">â¤</button>
</div>

<nav class="bottom-nav">
  <a href="school.html" class="nav-item">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><path d="M9 22V12h6v10"/></svg>
    Escuela
  </a>
  <a href="apps.html" class="nav-item">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
    Apps
  </a>
  <a href="languages.html" class="nav-item">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
    Idiomas
  </a>
  <a href="calendar.html" class="nav-item">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><circle cx="8" cy="16" r="1" fill="currentColor"/><circle cx="12" cy="16" r="1" fill="currentColor"/></svg>
    Calendario
  </a>
  <a href="notes.html" class="nav-item">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>
    Notas
  </a>
  <a href="tasks.html" class="nav-item active">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
    Tareas
  </a>
  <a href="reminders.html" class="nav-item">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
    Recordatorios
  </a>
  <a href="projects.html" class="nav-item">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
    Proyectos
  </a>
</nav>

<script type="module" src="js/topbar.js?v=6"></script>
<script type="module">
import { supabase } from './js/supabase.js';

function fmtTime(iso) {
  const d = new Date(iso);
  return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}
function fmtDateShort(iso) {
  const d = new Date(iso);
  return d.toLocaleDateString([], { month: 'short', day: 'numeric' });
}

async function loadMessages() {
  const el = document.getElementById('chat-messages');

  // Load Luke's messages (from claude_tasks â€” treat all as messages)
  const [tasksRes, notifRes] = await Promise.all([
    supabase.from('claude_tasks')
      .select('id, instruction, status, context, created_at')
      .order('created_at', { ascending: true }),
    supabase.from('claude_notifications')
      .select('id, title, body, created_at')
      .like('title', 'ğŸ’¬ Claude:%')
      .order('created_at', { ascending: true })
  ]);

  const lukeMsgs = (tasksRes.data || []).map(t => ({
    role: 'luke',
    text: t.instruction,
    status: t.status,
    context: t.context,
    time: t.created_at,
    id: 'task-' + t.id,
  }));

  const claudeMsgs = (notifRes.data || []).map(n => ({
    role: 'claude',
    text: n.body || n.title,
    time: n.created_at,
    id: 'notif-' + n.id,
  }));

  // Merge and sort by time
  const all = [...lukeMsgs, ...claudeMsgs].sort((a, b) => new Date(a.time) - new Date(b.time));

  if (!all.length) {
    el.innerHTML = `<div class="chat-empty">
      <div style="font-size:32px;margin-bottom:8px">ğŸ’¬</div>
      <div style="font-weight:600;margin-bottom:4px">Sin mensajes aÃºn</div>
      <div style="font-size:13px">EnvÃ­a un mensaje y Claude responderÃ¡ en la prÃ³xima sesiÃ³n de LifeOS.</div>
    </div>`;
    return;
  }

  let html = '';
  let lastDate = null;
  for (const msg of all) {
    const msgDate = fmtDateShort(msg.time);
    if (msgDate !== lastDate) {
      html += `<div class="chat-date-divider">${msgDate}</div>`;
      lastDate = msgDate;
    }
    const statusBadge = msg.status === 'done'
      ? '<div class="chat-status">âœ“ LeÃ­do por Claude</div>'
      : msg.status === 'open' ? '<div class="chat-status">â—‹ Pendiente</div>' : '';

    if (msg.role === 'luke') {
      html += `<div class="chat-bubble luke" id="${msg.id}">
        ${esc(msg.text)}
        ${msg.context ? `<div style="font-size:12px;opacity:0.7;margin-top:4px">ğŸ“ ${esc(msg.context)}</div>` : ''}
        <div class="chat-meta">${fmtTime(msg.time)} ${statusBadge}</div>
      </div>`;
    } else {
      html += `<div class="chat-bubble claude" id="${msg.id}">
        <div style="font-size:11px;font-weight:700;color:var(--blue);margin-bottom:4px">Claude</div>
        ${esc(msg.text)}
        <div class="chat-meta">${fmtTime(msg.time)}</div>
      </div>`;
    }
  }

  el.innerHTML = html;
  // Scroll to bottom
  el.scrollTop = el.scrollHeight;
}

function esc(str) {
  return (str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
}

window.sendMessage = async () => {
  const input = document.getElementById('chat-input');
  const text = input.value.trim();
  if (!text) return;
  const btn = document.getElementById('chat-send-btn');
  btn.disabled = true;
  const { error } = await supabase.from('claude_tasks').insert({
    instruction: text, status: 'open', context: 'chat.html', page: 'chat.html',
  });
  if (error) { alert('Error sending: ' + error.message); btn.disabled = false; return; }
  input.value = '';
  input.style.height = '';
  btn.disabled = false;
  loadMessages();
};

// â”€â”€ Slash command logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _slashActive = false;
let _slashIdx = 0;
const SLASH_CMDS = ['remind','task','note'];

window.onChatInput = (el) => {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
  const val = el.value;
  const menu = document.getElementById('slash-menu');
  if (val === '/') {
    _slashActive = true; _slashIdx = 0;
    menu.style.display = '';
    highlightSlashItem(_slashIdx);
  } else if (_slashActive && val.startsWith('/')) {
    const query = val.slice(1).toLowerCase();
    const match = SLASH_CMDS.filter(c => c.startsWith(query));
    if (match.length === 0) { hideSlashMenu(); }
    // Update highlight
  } else {
    hideSlashMenu();
  }
};

window.onChatKeydown = (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    if (_slashActive) {
      e.preventDefault();
      const items = document.querySelectorAll('.slash-menu-item');
      const active = items[_slashIdx];
      if (active) selectSlashCmd(active.dataset.cmd);
      return;
    }
    e.preventDefault();
    sendMessage();
    return;
  }
  if (_slashActive) {
    if (e.key === 'ArrowDown') { e.preventDefault(); _slashIdx = Math.min(_slashIdx+1, SLASH_CMDS.length-1); highlightSlashItem(_slashIdx); return; }
    if (e.key === 'ArrowUp')   { e.preventDefault(); _slashIdx = Math.max(_slashIdx-1, 0); highlightSlashItem(_slashIdx); return; }
    if (e.key === 'Escape')    { hideSlashMenu(); return; }
    if (e.key === 'Backspace' && document.getElementById('chat-input').value === '/') {
      hideSlashMenu();
    }
  }
};

function highlightSlashItem(idx) {
  document.querySelectorAll('.slash-menu-item').forEach((el, i) => {
    el.classList.toggle('active', i === idx);
  });
}
function hideSlashMenu() {
  _slashActive = false;
  document.getElementById('slash-menu').style.display = 'none';
}

window.selectSlashCmd = (cmd) => {
  hideSlashMenu();
  document.getElementById('chat-input').value = '';
  document.getElementById('chat-input').style.height = '';
  if (cmd === 'remind') {
    // Pre-fill today's date
    const today = new Date().toLocaleDateString('en-CA', { timeZone: 'America/Los_Angeles' });
    document.getElementById('cr-date').value = today;
    document.getElementById('cr-title').value = '';
    document.getElementById('cr-time').value = '';
    document.querySelectorAll('#cr-mod-pills .chat-pill').forEach(b => b.classList.remove('selected'));
    document.querySelector('#cr-mod-pills [data-mod="Personal"]').classList.add('selected');
    document.getElementById('chat-remind-modal').style.display = 'flex';
    setTimeout(() => document.getElementById('cr-title').focus(), 50);
  } else if (cmd === 'task') {
    document.getElementById('ct-title').value = '';
    document.querySelectorAll('#ct-cat-pills .chat-pill').forEach(b => b.classList.remove('selected'));
    document.querySelector('#ct-cat-pills [data-cat="Personal"]').classList.add('selected');
    document.getElementById('chat-task-modal').style.display = 'flex';
    setTimeout(() => document.getElementById('ct-title').focus(), 50);
  } else if (cmd === 'note') {
    document.getElementById('cn-title').value = '';
    document.getElementById('cn-body').value = '';
    document.getElementById('chat-note-modal').style.display = 'flex';
    setTimeout(() => document.getElementById('cn-title').focus(), 50);
  }
};

window.closeChatModal = (which) => {
  document.getElementById(`chat-${which}-modal`).style.display = 'none';
};

window.pickChatPill = (btn, groupId) => {
  document.querySelectorAll(`#${groupId} .chat-pill`).forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
};

// â”€â”€ /remind submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.submitChatRemind = async () => {
  const title = document.getElementById('cr-title').value.trim();
  if (!title) { alert('Escribe el recordatorio'); return; }
  const time  = document.getElementById('cr-time').value;
  const date  = document.getElementById('cr-date').value;
  const mod   = document.querySelector('#cr-mod-pills .chat-pill.selected')?.dataset.mod || 'Personal';
  const meta  = {};
  if (time) meta.due_time = time;
  const { error } = await supabase.from('reminders').insert({
    title, module: mod,
    due_date: date || null,
    status: 'active',
    notes: Object.keys(meta).length ? JSON.stringify(meta) : null,
  });
  if (error) { alert('Error: ' + error.message); return; }
  closeChatModal('remind');
  showToast(`ğŸ”” Recordatorio guardado${time ? ` Â· ${time} PST` : ''}`);
};

// â”€â”€ /task submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.submitChatTask = async () => {
  const title = document.getElementById('ct-title').value.trim();
  if (!title) { alert('Escribe la tarea'); return; }
  // tasks table uses `module`, not `category`
  const mod = document.querySelector('#ct-cat-pills .chat-pill.selected')?.dataset.cat || 'Personal';
  const { error } = await supabase.from('tasks').insert({
    title, module: mod, status: 'pending',
  });
  if (error) { alert('Error: ' + error.message); return; }
  closeChatModal('task');
  showToast('âœ… Tarea guardada');
};

// â”€â”€ /note submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Notes live in the `tasks` table with notes JSON {is_note:true, body:"..."}
// This matches how notes.js stores them â€” they show up in the Notes tab automatically.
window.submitChatNote = async () => {
  const title = document.getElementById('cn-title').value.trim();
  const body  = document.getElementById('cn-body').value.trim();
  if (!title && !body) { alert('Escribe algo'); return; }
  const noteTitle = title || body.substring(0, 60) || 'Nota rÃ¡pida';
  const now = new Date().toISOString();
  const { error } = await supabase.from('tasks').insert({
    title: noteTitle,
    module: 'Personal',
    status: 'open',
    notes: JSON.stringify({ is_note: true, body, color: 'none', pinned: false }),
    completed_at: now,
  });
  if (error) { alert('Error: ' + error.message); return; }
  closeChatModal('note');
  showToast('ğŸ“ Nota guardada');
};

// â”€â”€ Minimal toast for chat page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg) {
  const t = document.createElement('div');
  t.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#1f2937;color:#fff;padding:10px 18px;border-radius:99px;font-size:13px;font-weight:600;z-index:999;pointer-events:none';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 2500);
}

window.autoResize = (el) => {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
};

loadMessages();
</script>
</body>
</html>
