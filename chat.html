<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat ‚Äî Life OS</title>
<link rel="stylesheet" href="css/main.css?v=2">
<style>
.chat-wrap {
  display: flex;
  flex-direction: column;
  height: calc(100vh - 57px);
  padding-bottom: 80px;
}
.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 12px 16px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.chat-bubble {
  max-width: min(80%, calc(100vw - 48px));
  padding: 10px 14px;
  border-radius: 16px;
  font-size: 14px;
  line-height: 1.45;
  white-space: pre-wrap;
  word-break: break-word;
  overflow-wrap: anywhere;
  box-sizing: border-box;
}
.chat-bubble.luke {
  align-self: flex-end;
  background: var(--blue);
  color: #fff;
  border-bottom-right-radius: 4px;
  margin-left: 40px;
}
.chat-bubble.claude {
  align-self: flex-start;
  background: var(--gray-50);
  color: var(--gray-900);
  border: 1px solid var(--gray-200);
  border-bottom-left-radius: 4px;
  margin-right: 40px;
}
/* Mobile: tighter bubbles, shifted right */
@media (max-width: 600px) {
  .chat-bubble {
    max-width: min(58%, calc(100vw - 56px));
    padding: 7px 10px;
    font-size: 13px;
  }
  /* Luke bubbles: bigger left margin pushes them further right */
  .chat-bubble.luke  { margin-left: 48px; margin-right: 0; }
  /* Claude bubbles: pushed right by left margin, not pinned to left edge */
  .chat-bubble.claude { margin-left: 16px; margin-right: 48px; }
}
.chat-bubble .chat-meta {
  font-size: 11px;
  opacity: 0.6;
  margin-top: 4px;
}
.chat-bubble.luke .chat-meta { text-align: right; }
.chat-bubble .chat-status {
  font-size: 11px;
  opacity: 0.7;
  margin-top: 2px;
}
.chat-input-bar {
  position: fixed;
  bottom: var(--nav-height, 60px);
  left: 0; right: 0;
  background: var(--white);
  border-top: 1px solid var(--gray-200);
  padding: 10px 16px;
  display: flex;
  gap: 8px;
  z-index: 100;
}
.chat-input-bar textarea {
  flex: 1;
  border: 1px solid var(--gray-300);
  border-radius: 20px;
  padding: 8px 14px;
  font-size: 14px;
  resize: none;
  outline: none;
  min-height: 38px;
  max-height: 120px;
  font-family: inherit;
  line-height: 1.4;
}
.chat-input-bar textarea:focus {
  border-color: var(--blue);
}
.chat-send-btn {
  width: 38px; height: 38px;
  border-radius: 50%;
  background: var(--blue);
  color: white;
  border: none;
  font-size: 18px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.chat-send-btn:disabled { background: var(--gray-300); cursor: not-allowed; }
.chat-empty {
  text-align: center;
  color: var(--gray-400);
  padding: 40px 20px;
  font-size: 14px;
}
.chat-date-divider {
  text-align: center;
  font-size: 11px;
  color: var(--gray-400);
  margin: 4px 0;
}
</style>
</head>
<body>

<header class="page-header">
  <div class="header-row">
    <div>
      <h1>üí¨ Chat con Claude</h1>
      <div class="subtitle">Env√≠a mensajes, Claude responde cada sesi√≥n</div>
    </div>
  </div>
</header>

<div class="chat-wrap">
  <div class="chat-messages" id="chat-messages">
    <div class="chat-empty">
      <div style="font-size:32px;margin-bottom:8px">üí¨</div>
      Cargando mensajes‚Ä¶
    </div>
  </div>
</div>

<div class="chat-input-bar">
  <textarea id="chat-input" placeholder="Mensaje para Claude‚Ä¶" rows="1"
    oninput="autoResize(this)"
    onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage()}"></textarea>
  <button class="chat-send-btn" onclick="sendMessage()" id="chat-send-btn">‚û§</button>
</div>

<nav class="bottom-nav">
  <a href="school.html" class="nav-item">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><path d="M9 22V12h6v10"/></svg>
    Escuela
  </a>
  <a href="apps.html" class="nav-item">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
    Apps
  </a>
  <a href="languages.html" class="nav-item">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
    Idiomas
  </a>
  <a href="calendar.html" class="nav-item">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><circle cx="8" cy="16" r="1" fill="currentColor"/><circle cx="12" cy="16" r="1" fill="currentColor"/></svg>
    Calendario
  </a>
  <a href="tasks.html" class="nav-item active">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
    Tareas
  </a>
</nav>

<script type="module" src="js/topbar.js"></script>
<script type="module">
import { supabase } from './js/supabase.js';

function fmtTime(iso) {
  const d = new Date(iso);
  return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}
function fmtDateShort(iso) {
  const d = new Date(iso);
  return d.toLocaleDateString([], { month: 'short', day: 'numeric' });
}

async function loadMessages() {
  const el = document.getElementById('chat-messages');

  // Load Luke's messages (from claude_tasks ‚Äî treat all as messages)
  const [tasksRes, notifRes] = await Promise.all([
    supabase.from('claude_tasks')
      .select('id, instruction, status, context, created_at')
      .order('created_at', { ascending: true }),
    supabase.from('claude_notifications')
      .select('id, title, body, created_at')
      .like('title', 'üí¨ Claude:%')
      .order('created_at', { ascending: true })
  ]);

  const lukeMsgs = (tasksRes.data || []).map(t => ({
    role: 'luke',
    text: t.instruction,
    status: t.status,
    context: t.context,
    time: t.created_at,
    id: 'task-' + t.id,
  }));

  const claudeMsgs = (notifRes.data || []).map(n => ({
    role: 'claude',
    text: n.body || n.title,
    time: n.created_at,
    id: 'notif-' + n.id,
  }));

  // Merge and sort by time
  const all = [...lukeMsgs, ...claudeMsgs].sort((a, b) => new Date(a.time) - new Date(b.time));

  if (!all.length) {
    el.innerHTML = `<div class="chat-empty">
      <div style="font-size:32px;margin-bottom:8px">üí¨</div>
      <div style="font-weight:600;margin-bottom:4px">Sin mensajes a√∫n</div>
      <div style="font-size:13px">Env√≠a un mensaje y Claude responder√° en la pr√≥xima sesi√≥n de LifeOS.</div>
    </div>`;
    return;
  }

  let html = '';
  let lastDate = null;
  for (const msg of all) {
    const msgDate = fmtDateShort(msg.time);
    if (msgDate !== lastDate) {
      html += `<div class="chat-date-divider">${msgDate}</div>`;
      lastDate = msgDate;
    }
    const statusBadge = msg.status === 'done'
      ? '<div class="chat-status">‚úì Le√≠do por Claude</div>'
      : msg.status === 'open' ? '<div class="chat-status">‚óã Pendiente</div>' : '';

    if (msg.role === 'luke') {
      html += `<div class="chat-bubble luke" id="${msg.id}">
        ${esc(msg.text)}
        ${msg.context ? `<div style="font-size:12px;opacity:0.7;margin-top:4px">üìç ${esc(msg.context)}</div>` : ''}
        <div class="chat-meta">${fmtTime(msg.time)} ${statusBadge}</div>
      </div>`;
    } else {
      html += `<div class="chat-bubble claude" id="${msg.id}">
        <div style="font-size:11px;font-weight:700;color:var(--blue);margin-bottom:4px">Claude</div>
        ${esc(msg.text)}
        <div class="chat-meta">${fmtTime(msg.time)}</div>
      </div>`;
    }
  }

  el.innerHTML = html;
  // Scroll to bottom
  el.scrollTop = el.scrollHeight;
}

function esc(str) {
  return (str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
}

window.sendMessage = async () => {
  const input = document.getElementById('chat-input');
  const text = input.value.trim();
  if (!text) return;

  const btn = document.getElementById('chat-send-btn');
  btn.disabled = true;

  const { error } = await supabase.from('claude_tasks').insert({
    instruction: text,
    status: 'open',
    context: 'chat.html',
    page: 'chat.html',
  });

  if (error) {
    alert('Error sending: ' + error.message);
    btn.disabled = false;
    return;
  }

  input.value = '';
  input.style.height = '';
  btn.disabled = false;
  loadMessages();
};

window.autoResize = (el) => {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
};

loadMessages();
</script>
</body>
</html>
