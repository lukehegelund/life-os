<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scheduled Tasks â€” Life OS</title>
<link rel="stylesheet" href="css/main.css?v=2">
<style>
.modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:500; align-items:flex-end; justify-content:center; }
.modal-sheet { background:var(--white); border-radius:16px 16px 0 0; padding:20px; width:100%; max-width:600px; max-height:90vh; overflow-y:auto; }
.modal-title { font-size:17px; font-weight:700; margin-bottom:16px; }

.sched-card {
  background: var(--white);
  border-radius: 12px;
  box-shadow: var(--shadow);
  padding: 14px 16px;
  margin-bottom: 10px;
  display: flex;
  gap: 12px;
  align-items: flex-start;
}
.sched-icon {
  width: 36px; height: 36px;
  border-radius: 8px;
  background: var(--blue-light, #eff6ff);
  display: flex; align-items: center; justify-content: center;
  font-size: 16px; flex-shrink: 0;
}
.sched-body { flex: 1; min-width: 0; }
.sched-title { font-size: 15px; font-weight: 600; color: var(--gray-900); line-height: 1.3; margin-bottom: 3px; }
.sched-meta { font-size: 12px; color: var(--gray-500); display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
.sched-badge {
  display: inline-flex; align-items: center; gap: 3px;
  padding: 2px 7px; border-radius: 99px;
  font-size: 11px; font-weight: 600;
  background: var(--blue-light, #eff6ff); color: var(--blue);
}
.sched-badge.active { background: #ecfdf5; color: #059669; }
.sched-badge.paused { background: #fef9c3; color: #a16207; }
.interval-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
.interval-btn {
  padding: 10px; border-radius: 10px; border: 2px solid var(--gray-200);
  background: var(--white); font-size: 13px; font-weight: 500; cursor: pointer;
  text-align: center; transition: all 0.15s; color: var(--gray-700);
}
.interval-btn:hover { border-color: var(--blue); background: var(--blue-light, #eff6ff); color: var(--blue); }
.interval-btn.selected { border-color: var(--blue); background: var(--blue); color: white; }
.empty-state { text-align: center; padding: 40px 20px; color: var(--gray-400); }
.empty-state .empty-icon { font-size: 36px; margin-bottom: 12px; }
.empty-state .empty-title { font-size: 16px; font-weight: 600; color: var(--gray-600); margin-bottom: 6px; }
.empty-state .empty-sub { font-size: 13px; }
</style>
</head>
<body>

<header class="page-header">
  <div class="header-row">
    <div>
      <h1>â° Scheduled Tasks</h1>
      <div class="subtitle" id="sched-subtitle">Tasks Claude runs on a repeat schedule</div>
    </div>
    <button class="btn btn-primary btn-sm" onclick="showAddModal()" style="margin-left:auto;flex-shrink:0">+ New</button>
  </div>
</header>

<main class="content">
  <!-- Active tasks -->
  <div id="active-section">
    <div class="empty-state">
      <div class="empty-icon">ğŸ”„</div>
      <div class="empty-title">No scheduled tasks yet</div>
      <div class="empty-sub">Tap "+ New" to create a task Claude will run on a regular interval.</div>
    </div>
  </div>

  <!-- Paused tasks -->
  <div id="paused-section"></div>
</main>

<!-- Add/Edit Scheduled Task Modal -->
<div class="modal-overlay" id="add-modal" onclick="if(event.target===this)closeAddModal()">
  <div class="modal-sheet">
    <div class="modal-title" id="modal-title-text">â° New Scheduled Task</div>

    <div class="form-group">
      <label class="form-label">Task instruction for Claude</label>
      <textarea class="form-input" id="sched-instruction" rows="3"
        placeholder="e.g. Check the worship schedule and notify me if any Wednesdays are missing a team"
        style="resize:vertical;font-size:14px;line-height:1.5"></textarea>
    </div>

    <div class="form-group">
      <label class="form-label">How often?</label>
      <div class="interval-grid">
        <button class="interval-btn" data-val="daily" onclick="selectInterval(this)">ğŸ“… Every day</button>
        <button class="interval-btn" data-val="weekdays" onclick="selectInterval(this)">ğŸ« Weekdays only</button>
        <button class="interval-btn" data-val="weekly:Mon" onclick="selectInterval(this)">ğŸ“† Every Monday</button>
        <button class="interval-btn" data-val="weekly:Wed" onclick="selectInterval(this)">ğŸ“† Every Wednesday</button>
        <button class="interval-btn" data-val="weekly:Thu" onclick="selectInterval(this)">ğŸ“† Every Thursday</button>
        <button class="interval-btn" data-val="weekly:Fri" onclick="selectInterval(this)">ğŸ“† Every Friday</button>
        <button class="interval-btn" data-val="biweekly" onclick="selectInterval(this)">ğŸ—“ï¸ Every 2 weeks</button>
        <button class="interval-btn" data-val="monthly" onclick="selectInterval(this)">ğŸ—“ï¸ Monthly</button>
      </div>
      <input type="text" class="form-input" id="sched-interval-custom"
        placeholder="Custom (e.g. 'every 3 days', 'every Sunday')"
        style="font-size:13px;margin-top:4px"
        oninput="clearIntervalBtns()">
      <input type="hidden" id="sched-interval-val">
    </div>

    <div class="form-group">
      <label class="form-label">Label (short name for display)</label>
      <input type="text" class="form-input" id="sched-label"
        placeholder="e.g. 'Worship Check', 'Wedding Inquiry Check'">
    </div>

    <div style="display:flex;gap:8px;margin-top:4px">
      <button class="btn btn-primary" style="flex:1" onclick="submitScheduled()">Save Task</button>
      <button class="btn btn-ghost" onclick="closeAddModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- Delete confirmation -->
<div class="modal-overlay" id="delete-modal" onclick="if(event.target===this)closeDeleteModal()">
  <div class="modal-sheet">
    <div class="modal-title">ğŸ—‘ï¸ Delete scheduled task?</div>
    <p style="font-size:14px;color:var(--gray-600);margin-bottom:16px" id="delete-confirm-text">This will remove the task permanently.</p>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost" style="flex:1;background:#fef2f2;color:#dc2626;border-color:#fecaca"
        onclick="confirmDelete()">Delete</button>
      <button class="btn btn-ghost" style="flex:1" onclick="closeDeleteModal()">Cancel</button>
    </div>
  </div>
</div>

<nav class="bottom-nav">
  <a href="school.html" class="nav-item">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><path d="M9 22V12h6v10"/></svg>
    Escuela
  </a>
  <a href="apps.html" class="nav-item">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
    Apps
  </a>
  <a href="index.html" class="nav-item">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
    Panel
  </a>
  <a href="calendar.html" class="nav-item">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><circle cx="8" cy="16" r="1" fill="currentColor"/><circle cx="12" cy="16" r="1" fill="currentColor"/></svg>
    Calendario
  </a>
  <a href="tasks.html" class="nav-item">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
    Tareas
  </a>
</nav>

<script type="module">
import { supabase } from './js/supabase.js';
import { toast } from './js/utils.js';

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allTasks = [];
let editingId = null;
let deletingId = null;

// â”€â”€ Load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function load() {
  // Fetch reminders that are tagged as claude scheduled tasks
  const { data, error } = await supabase
    .from('reminders')
    .select('*')
    .eq('recurring', true)
    .order('created_at', { ascending: true });

  if (error) { console.error(error); return; }

  // Filter to only our scheduled claude tasks (marked in notes JSON)
  allTasks = (data || []).filter(r => {
    try { return JSON.parse(r.notes || '{}').claude_schedule === true; }
    catch { return false; }
  });

  render();
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  const active = allTasks.filter(t => t.status === 'active');
  const paused = allTasks.filter(t => t.status !== 'active');

  const activeEl = document.getElementById('active-section');
  const pausedEl = document.getElementById('paused-section');

  document.getElementById('sched-subtitle').textContent =
    allTasks.length === 0 ? 'Tasks Claude runs on a repeat schedule'
    : `${active.length} active Â· ${paused.length} paused`;

  if (active.length === 0) {
    activeEl.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">ğŸ”„</div>
        <div class="empty-title">No scheduled tasks yet</div>
        <div class="empty-sub">Tap "+ New" to create a task Claude will run on a regular interval.</div>
      </div>`;
  } else {
    activeEl.innerHTML = `
      <div style="font-size:12px;font-weight:700;color:var(--gray-500);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">
        Active (${active.length})
      </div>
      ${active.map(t => taskCard(t)).join('')}`;
  }

  if (paused.length > 0) {
    pausedEl.innerHTML = `
      <div style="font-size:12px;font-weight:700;color:var(--gray-500);text-transform:uppercase;letter-spacing:.5px;margin:16px 0 8px">
        Paused (${paused.length})
      </div>
      ${paused.map(t => taskCard(t)).join('')}`;
  } else {
    pausedEl.innerHTML = '';
  }
}

function taskCard(t) {
  let meta = {};
  try { meta = JSON.parse(t.notes || '{}'); } catch {}

  const isActive = t.status === 'active';
  const intervalLabel = meta.interval_label || t.recurrence_pattern || 'Custom';
  const instruction = meta.instruction || t.title;
  const label = meta.label || t.title;
  const icon = meta.icon || 'â°';

  return `
    <div class="sched-card">
      <div class="sched-icon">${icon}</div>
      <div class="sched-body">
        <div class="sched-title">${label}</div>
        <div style="font-size:12px;color:var(--gray-600);margin-bottom:6px;line-height:1.4">${instruction}</div>
        <div class="sched-meta">
          <span class="sched-badge ${isActive ? 'active' : 'paused'}">${isActive ? 'â— Active' : 'â¸ Paused'}</span>
          <span>ğŸ”„ ${intervalLabel}</span>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;flex-shrink:0">
        <button class="btn btn-sm btn-ghost" onclick="editTask(${t.id})" title="Edit" style="font-size:16px;padding:4px 8px">âœï¸</button>
        <button class="btn btn-sm btn-ghost" onclick="togglePause(${t.id}, ${isActive})" title="${isActive ? 'Pause' : 'Resume'}" style="font-size:16px;padding:4px 8px">${isActive ? 'â¸' : 'â–¶ï¸'}</button>
        <button class="btn btn-sm btn-ghost" onclick="deleteTask(${t.id}, '${label.replace(/'/g, "\\'")}')" title="Delete" style="font-size:16px;padding:4px 8px">ğŸ—‘ï¸</button>
      </div>
    </div>`;
}

// â”€â”€ Modal helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.showAddModal = () => {
  editingId = null;
  document.getElementById('modal-title-text').textContent = 'â° New Scheduled Task';
  document.getElementById('sched-instruction').value = '';
  document.getElementById('sched-label').value = '';
  document.getElementById('sched-interval-val').value = '';
  document.getElementById('sched-interval-custom').value = '';
  document.querySelectorAll('.interval-btn').forEach(b => b.classList.remove('selected'));
  document.getElementById('add-modal').style.display = 'flex';
};

window.closeAddModal = () => {
  document.getElementById('add-modal').style.display = 'none';
};

window.selectInterval = (btn) => {
  document.querySelectorAll('.interval-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  document.getElementById('sched-interval-val').value = btn.dataset.val;
  document.getElementById('sched-interval-custom').value = '';
};

window.clearIntervalBtns = () => {
  document.querySelectorAll('.interval-btn').forEach(b => b.classList.remove('selected'));
  document.getElementById('sched-interval-val').value = '';
};

const INTERVAL_LABELS = {
  'daily': 'Every day',
  'weekdays': 'Every weekday (Monâ€“Fri)',
  'weekly:Mon': 'Every Monday',
  'weekly:Tue': 'Every Tuesday',
  'weekly:Wed': 'Every Wednesday',
  'weekly:Thu': 'Every Thursday',
  'weekly:Fri': 'Every Friday',
  'biweekly': 'Every 2 weeks',
  'monthly': 'Monthly',
};

const INTERVAL_ICONS = {
  'daily': 'ğŸ“…',
  'weekdays': 'ğŸ«',
  'weekly:Mon': 'ğŸ“†',
  'weekly:Tue': 'ğŸ“†',
  'weekly:Wed': 'ğŸ“†',
  'weekly:Thu': 'ğŸ“†',
  'weekly:Fri': 'ğŸ“†',
  'biweekly': 'ğŸ—“ï¸',
  'monthly': 'ğŸ—“ï¸',
};

window.submitScheduled = async () => {
  const instruction = document.getElementById('sched-instruction').value.trim();
  const label = document.getElementById('sched-label').value.trim() || instruction.slice(0, 40);
  const intervalVal = document.getElementById('sched-interval-val').value ||
                      document.getElementById('sched-interval-custom').value.trim();

  if (!instruction) { toast('Add an instruction for Claude'); return; }
  if (!intervalVal) { toast('Select how often this should run'); return; }

  const intervalLabel = INTERVAL_LABELS[intervalVal] || intervalVal;
  const icon = INTERVAL_ICONS[intervalVal] || 'â°';

  const notesJSON = JSON.stringify({
    claude_schedule: true,
    instruction,
    label,
    interval_label: intervalLabel,
    icon,
  });

  let result;
  if (editingId) {
    result = await supabase.from('reminders')
      .update({ title: label, recurrence_pattern: intervalVal, notes: notesJSON })
      .eq('id', editingId);
  } else {
    result = await supabase.from('reminders').insert({
      title: label,
      module: 'Personal',
      recurring: true,
      recurrence_pattern: intervalVal,
      status: 'active',
      notes: notesJSON,
    });
  }

  if (result.error) { toast('Error saving: ' + result.error.message); return; }

  closeAddModal();
  toast(editingId ? 'âœ… Task updated' : 'âœ… Scheduled task created');
  await load();
};

window.editTask = (id) => {
  const task = allTasks.find(t => t.id === id);
  if (!task) return;
  let meta = {};
  try { meta = JSON.parse(task.notes || '{}'); } catch {}

  editingId = id;
  document.getElementById('modal-title-text').textContent = 'âœï¸ Edit Scheduled Task';
  document.getElementById('sched-instruction').value = meta.instruction || task.title;
  document.getElementById('sched-label').value = meta.label || task.title;

  // Pre-select interval
  const val = task.recurrence_pattern || '';
  document.getElementById('sched-interval-val').value = val;
  document.getElementById('sched-interval-custom').value = '';
  document.querySelectorAll('.interval-btn').forEach(b => {
    b.classList.toggle('selected', b.dataset.val === val);
  });
  if (!document.querySelector('.interval-btn.selected') && val) {
    document.getElementById('sched-interval-custom').value = val;
  }

  document.getElementById('add-modal').style.display = 'flex';
};

window.togglePause = async (id, isActive) => {
  const newStatus = isActive ? 'dismissed' : 'active';
  const { error } = await supabase.from('reminders').update({ status: newStatus }).eq('id', id);
  if (error) { toast('Error: ' + error.message); return; }
  toast(isActive ? 'â¸ Task paused' : 'â–¶ï¸ Task resumed');
  await load();
};

window.deleteTask = (id, label) => {
  deletingId = id;
  document.getElementById('delete-confirm-text').textContent = `Delete "${label}"? This cannot be undone.`;
  document.getElementById('delete-modal').style.display = 'flex';
};

window.closeDeleteModal = () => {
  document.getElementById('delete-modal').style.display = 'none';
  deletingId = null;
};

window.confirmDelete = async () => {
  if (!deletingId) return;
  const { error } = await supabase.from('reminders').delete().eq('id', deletingId);
  if (error) { toast('Error: ' + error.message); return; }
  closeDeleteModal();
  toast('ğŸ—‘ï¸ Task deleted');
  await load();
};

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
load();
</script>
<script type="module" src="js/topbar.js"></script>
</body>
</html>
